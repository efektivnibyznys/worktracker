<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Tracker - Sledov√°n√≠ pr√°ce</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .nav-item {
            padding: 0.5rem 1rem;
            color: #4B5563;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item:hover {
            color: #2563EB;
        }
        .nav-item.active {
            color: #2563EB;
            border-bottom: 2px solid #2563EB;
        }
        .btn-primary {
            background-color: #2563EB;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #1D4ED8;
        }
        .btn-secondary {
            background-color: #E5E7EB;
            color: #374151;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-secondary:hover {
            background-color: #D1D5DB;
        }
        .btn-danger {
            background-color: #DC2626;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            border: none;
            cursor: pointer;
        }
        .btn-danger:hover {
            background-color: #B91C1C;
        }
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }
        .input-field {
            width: 100%;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
        }
        .input-field:focus {
            outline: none;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        .label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        .status-active {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .status-completed {
            background-color: #DBEAFE;
            color: #1E40AF;
        }
        .status-paused {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .save-indicator {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            z-index: 1000;
        }
        .save-indicator.saved {
            background-color: #D1FAE5;
            color: #065F46;
        }
        .save-indicator.unsaved {
            background-color: #FEF3C7;
            color: #92400E;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 42rem;
            width: 100%;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="save-indicator hidden">
        <span id="syncIndicatorText"></span>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen bg-gray-50 flex items-center justify-center">
        <div class="card max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-center mb-6">‚è±Ô∏è Work Tracker</h2>

            <!-- Login Form -->
            <div id="loginForm">
                <h3 class="text-lg font-semibold mb-4">P≈ôihl√°≈°en√≠</h3>
                <form id="loginFormElement">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Email</label>
                            <input type="email" id="loginEmail" class="input-field" required autocomplete="email">
                        </div>
                        <div>
                            <label class="label">Heslo</label>
                            <input type="password" id="loginPassword" class="input-field" required autocomplete="current-password">
                        </div>
                        <button type="submit" class="btn-primary w-full">P≈ôihl√°sit se</button>
                    </div>
                </form>
                <p class="text-center mt-4 text-sm text-gray-600">
                    Nem√°te √∫ƒçet?
                    <button id="showRegisterBtn" class="text-blue-600 hover:text-blue-700">Registrovat se</button>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h3 class="text-lg font-semibold mb-4">Registrace</h3>
                <form id="registerFormElement">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Email</label>
                            <input type="email" id="registerEmail" class="input-field" required autocomplete="email">
                        </div>
                        <div>
                            <label class="label">Heslo (min. 6 znak≈Ø)</label>
                            <input type="password" id="registerPassword" class="input-field" required minlength="6" autocomplete="new-password">
                        </div>
                        <button type="submit" class="btn-primary w-full">Vytvo≈ôit √∫ƒçet</button>
                    </div>
                </form>
                <p class="text-center mt-4 text-sm text-gray-600">
                    U≈æ m√°te √∫ƒçet?
                    <button id="showLoginBtn" class="text-blue-600 hover:text-blue-700">P≈ôihl√°sit se</button>
                </p>
            </div>

            <div id="authMessage" class="mt-4 p-3 rounded hidden"></div>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold text-gray-900">‚è±Ô∏è Work Tracker</h1>
                    <div id="authInfo" class="flex items-center gap-4">
                        <span id="userEmail" class="text-sm text-gray-600"></span>
                        <button id="logoutBtn" class="btn-secondary text-sm">Odhl√°sit se</button>
                    </div>
                </div>
            </div>
        </header>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex space-x-1">
                <div class="nav-item active" data-section="dashboard">Dashboard</div>
                <div class="nav-item" data-section="clients">Klienti</div>
                <div class="nav-item" data-section="entries">Z√°znamy</div>
                <div class="nav-item" data-section="reports">Reporty</div>
                <div class="nav-item" data-section="settings">Nastaven√≠</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active">
            <!-- Filters -->
            <div class="card mb-6">
                <h2 class="text-xl font-bold mb-4">Filtry</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="label">Klient</label>
                        <select id="dashboardFilterClient" class="input-field">
                            <option value="">V≈°ichni klienti</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">F√°ze</label>
                        <select id="dashboardFilterPhase" class="input-field">
                            <option value="">V≈°echny f√°ze</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Od data</label>
                        <input type="date" id="dashboardFilterDateFrom" class="input-field">
                    </div>
                    <div>
                        <label class="label">Do data</label>
                        <input type="date" id="dashboardFilterDateTo" class="input-field">
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button id="applyDashboardFilters" class="btn-primary">Pou≈æ√≠t filtry</button>
                    <button id="resetDashboardFilters" class="btn-secondary">Resetovat</button>
                </div>
            </div>

            <!-- Filtered Totals -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="card">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Celkem hodin</h3>
                    <p class="text-3xl font-bold text-gray-900" id="filteredTotalHours">0 h</p>
                </div>
                <div class="card">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Celkov√° ƒç√°stka</h3>
                    <p class="text-3xl font-bold text-gray-900" id="filteredTotalAmount">0 Kƒç</p>
                </div>
                <div class="card">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Poƒçet ƒçinnost√≠</h3>
                    <p class="text-3xl font-bold text-gray-900" id="filteredTotalCount">0</p>
                </div>
            </div>

            <!-- Filtered Entries List -->
            <div class="card mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold">Detailn√≠ seznam ƒçinnost√≠</h2>
                    <button id="toggleFilteredEntries" class="btn-secondary text-sm">Zobrazit/Skr√Ωt</button>
                </div>
                <div id="filteredEntriesList" class="space-y-3" style="display: none;">
                    <p class="text-gray-500 text-sm">≈Ω√°dn√© ƒçinnosti</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Dnes</h3>
                    <p class="text-3xl font-bold text-gray-900" id="statsToday">0 h</p>
                    <p class="text-sm text-gray-600 mt-1" id="statsTodayAmount">0 Kƒç</p>
                </div>
                <div class="card">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Tento t√Ωden</h3>
                    <p class="text-3xl font-bold text-gray-900" id="statsWeek">0 h</p>
                    <p class="text-sm text-gray-600 mt-1" id="statsWeekAmount">0 Kƒç</p>
                </div>
                <div class="card">
                    <h3 class="text-sm font-medium text-gray-500 mb-2">Tento mƒõs√≠c</h3>
                    <p class="text-3xl font-bold text-gray-900" id="statsMonth">0 h</p>
                    <p class="text-sm text-gray-600 mt-1" id="statsMonthAmount">0 Kƒç</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Quick Add -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">P≈ôidat z√°znam</h2>
                    <form id="quickAddForm">
                        <div class="space-y-4">
                            <div>
                                <label class="label">Klient *</label>
                                <select id="quickClientId" class="input-field" required>
                                    <option value="">Vyberte klienta</option>
                                </select>
                            </div>
                            <div>
                                <label class="label">F√°ze projektu</label>
                                <select id="quickPhaseId" class="input-field">
                                    <option value="">Bez f√°ze</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="label">Datum *</label>
                                    <input type="date" id="quickDate" class="input-field" required>
                                </div>
                                <div>
                                    <label class="label">Hodinov√° sazba</label>
                                    <input type="number" id="quickRate" class="input-field" placeholder="Auto">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="label">ƒåas od *</label>
                                    <input type="time" id="quickStartTime" class="input-field" required>
                                </div>
                                <div>
                                    <label class="label">ƒåas do *</label>
                                    <input type="time" id="quickEndTime" class="input-field" required>
                                </div>
                            </div>
                            <div>
                                <label class="label">Popis pr√°ce *</label>
                                <textarea id="quickDescription" class="input-field" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn-primary w-full">P≈ôidat z√°znam</button>
                        </div>
                    </form>
                </div>

                <!-- Recent Entries -->
                <div class="card">
                    <h2 class="text-xl font-bold mb-4">Posledn√≠ z√°znamy</h2>
                    <div id="recentEntries" class="space-y-3">
                        <p class="text-gray-500 text-sm">≈Ω√°dn√© z√°znamy</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="mt-8">
                <h2 class="text-2xl font-bold mb-6">Mƒõs√≠ƒçn√≠ p≈ôehled</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Clients Chart -->
                    <div class="card">
                        <h3 class="text-lg font-bold mb-4">Rozdƒõlen√≠ podle klient≈Ø</h3>
                        <canvas id="clientsChart"></canvas>
                    </div>

                    <!-- Phases Chart -->
                    <div class="card">
                        <h3 class="text-lg font-bold mb-4">Rozdƒõlen√≠ podle f√°z√≠</h3>
                        <canvas id="phasesChart"></canvas>
                    </div>
                </div>

                <!-- Timeline Chart -->
                <div class="card">
                    <h3 class="text-lg font-bold mb-4">ƒåasov√Ω p≈ôehled mƒõs√≠ce</h3>
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Clients Section -->
        <section id="clients" class="section">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Klienti</h2>
                <button id="addClientBtn" class="btn-primary">+ P≈ôidat klienta</button>
            </div>
            <div id="clientsList" class="space-y-4">
                <p class="text-gray-500">≈Ω√°dn√≠ klienti</p>
            </div>
        </section>

        <!-- Entries Section -->
        <section id="entries" class="section">
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-4">Z√°znamy pr√°ce</h2>
                <div class="card">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="label">Klient</label>
                            <select id="filterClient" class="input-field">
                                <option value="">V≈°ichni klienti</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">F√°ze</label>
                            <select id="filterPhase" class="input-field">
                                <option value="">V≈°echny f√°ze</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">Od data</label>
                            <input type="date" id="filterDateFrom" class="input-field">
                        </div>
                        <div>
                            <label class="label">Do data</label>
                            <input type="date" id="filterDateTo" class="input-field">
                        </div>
                    </div>
                </div>
            </div>
            <div id="entriesList" class="space-y-4">
                <p class="text-gray-500">≈Ω√°dn√© z√°znamy</p>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="section">
            <h2 class="text-2xl font-bold mb-6">Reporty a p≈ôehledy</h2>
            <div class="card mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="label">Klient</label>
                        <select id="reportClient" class="input-field">
                            <option value="">V≈°ichni klienti</option>
                        </select>
                    </div>
                    <div>
                        <label class="label">Od data</label>
                        <input type="date" id="reportDateFrom" class="input-field">
                    </div>
                    <div>
                        <label class="label">Do data</label>
                        <input type="date" id="reportDateTo" class="input-field">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="generateReportBtn" class="btn-primary">Vygenerovat report</button>
                    <button id="exportNotionBtn" class="btn-secondary">üìã Export pro Notion</button>
                </div>
            </div>

            <div id="reportResults" class="space-y-6">
                <div class="card">
                    <h3 class="text-lg font-bold mb-4">Souhrn</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <p class="text-sm text-gray-500">Celkem hodin</p>
                            <p class="text-2xl font-bold" id="reportTotalHours">0 h</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">K fakturaci</p>
                            <p class="text-2xl font-bold" id="reportTotalAmount">0 Kƒç</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500">Poƒçet z√°znam≈Ø</p>
                            <p class="text-2xl font-bold" id="reportTotalEntries">0</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold mb-4">Detaily</h3>
                    <div id="reportDetails">
                        <p class="text-gray-500">Vygenerujte report pro zobrazen√≠ detail≈Ø</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="section">
            <h2 class="text-2xl font-bold mb-6">Nastaven√≠</h2>
            <div class="card">
                <form id="settingsForm">
                    <div class="space-y-4">
                        <div>
                            <label class="label">V√Ωchoz√≠ hodinov√° sazba (Kƒç)</label>
                            <input type="number" id="settingsDefaultRate" class="input-field" min="0" step="100" value="850">
                        </div>
                        <div>
                            <label class="label">Mƒõna</label>
                            <input type="text" id="settingsCurrency" class="input-field" value="Kƒç">
                        </div>
                        <button type="submit" class="btn-primary">Ulo≈æit nastaven√≠</button>
                    </div>
                </form>
            </div>

            <div class="card mt-6">
                <h3 class="text-lg font-bold mb-4">Import dat</h3>
                <p class="text-sm text-gray-600 mb-4">Pokud jste pou≈æ√≠vali star≈°√≠ verzi aplikace s ukl√°d√°n√≠m do localStorage, m≈Ø≈æete importovat sv√° data do cloudu.</p>
                <button onclick="app.migrateLocalData()" class="btn-primary">üì§ Importovat lok√°ln√≠ data</button>
            </div>

            <div class="card mt-6">
                <h3 class="text-lg font-bold mb-4">O aplikaci</h3>
                <p class="text-gray-600 mb-2">Work Tracker v2.0 (Supabase)</p>
                <p class="text-sm text-gray-500">Aplikace pro sledov√°n√≠ odpracovan√©ho ƒçasu s cloudovou synchronizac√≠ p≈ôes Supabase.</p>
            </div>
        </section>
    </main>

    <!-- Client Modal -->
    <div id="clientModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" id="clientModalTitle">P≈ôidat klienta</h2>
                    <button id="closeClientModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <form id="clientForm">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Jm√©no klienta *</label>
                            <input type="text" id="clientName" class="input-field" required>
                        </div>
                        <div>
                            <label class="label">Hodinov√° sazba (Kƒç)</label>
                            <input type="number" id="clientRate" class="input-field" min="0" step="100" placeholder="Pou≈æije se v√Ωchoz√≠ sazba">
                        </div>
                        <div>
                            <label class="label">Pozn√°mka</label>
                            <textarea id="clientNote" class="input-field" rows="3"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn-primary">Ulo≈æit</button>
                            <button type="button" id="cancelClientModal" class="btn-secondary">Zru≈°it</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Phase Modal -->
    <div id="phaseModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" id="phaseModalTitle">P≈ôidat f√°zi</h2>
                    <button id="closePhaseModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <form id="phaseForm">
                    <div class="space-y-4">
                        <div>
                            <label class="label">N√°zev f√°ze *</label>
                            <input type="text" id="phaseName" class="input-field" required>
                        </div>
                        <div>
                            <label class="label">Popis</label>
                            <textarea id="phaseDescription" class="input-field" rows="2"></textarea>
                        </div>
                        <div>
                            <label class="label">Hodinov√° sazba (Kƒç)</label>
                            <input type="number" id="phaseRate" class="input-field" min="0" step="100" placeholder="Pou≈æije se sazba klienta">
                        </div>
                        <div>
                            <label class="label">Stav</label>
                            <select id="phaseStatus" class="input-field">
                                <option value="active">‚úÖ Aktivn√≠</option>
                                <option value="paused">‚è∏Ô∏è Pozastaven√°</option>
                                <option value="completed">‚òëÔ∏è Dokonƒçen√°</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn-primary">Ulo≈æit</button>
                            <button type="button" id="cancelPhaseModal" class="btn-secondary">Zru≈°it</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Entry Modal -->
    <div id="entryModal" class="modal">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold" id="entryModalTitle">Upravit z√°znam</h2>
                    <button id="closeEntryModal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <form id="entryForm">
                    <div class="space-y-4">
                        <div>
                            <label class="label">Klient *</label>
                            <select id="entryClientId" class="input-field" required>
                                <option value="">Vyberte klienta</option>
                            </select>
                        </div>
                        <div>
                            <label class="label">F√°ze projektu</label>
                            <select id="entryPhaseId" class="input-field">
                                <option value="">Bez f√°ze</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label">Datum *</label>
                                <input type="date" id="entryDate" class="input-field" required>
                            </div>
                            <div>
                                <label class="label">Hodinov√° sazba</label>
                                <input type="number" id="entryRate" class="input-field" placeholder="Auto">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="label">ƒåas od *</label>
                                <input type="time" id="entryStartTime" class="input-field" required>
                            </div>
                            <div>
                                <label class="label">ƒåas do *</label>
                                <input type="time" id="entryEndTime" class="input-field" required>
                            </div>
                        </div>
                        <div>
                            <label class="label">Popis pr√°ce *</label>
                            <textarea id="entryDescription" class="input-field" rows="3" required></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button type="submit" class="btn-primary">Ulo≈æit</button>
                            <button type="button" id="cancelEntryModal" class="btn-secondary">Zru≈°it</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div> <!-- End of mainApp -->

    <script>
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://tdgxfhoymdsjzrsctcxh.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkZ3hmaG95bWRqc3pyc2N0Y3hoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNDAxOTgsImV4cCI6MjA4MTYxNjE5OH0.wLFk32NNaVgbh72iSw4pbjqxf0lBNzTTB02DMbKfMhM'

        // Inicializace Supabase klienta
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // ============================================
        // AUTH MANAGER
        // ============================================
        class AuthManager {
            constructor() {
                this.currentUser = null;
                this.onAuthChangeCallback = null;
            }

            async init() {
                // Nejprve nastav event listenery
                this.setupAuthForms();

                try {
                    // Zkontroluj aktu√°ln√≠ session
                    const { data: { session }, error } = await supabase.auth.getSession();

                    if (error) {
                        console.error('Auth error:', error);
                        this.showLoginScreen();
                        return;
                    }

                    if (session) {
                        this.currentUser = session.user;
                        this.showMainApp();
                    } else {
                        this.showLoginScreen();
                    }

                    // Poslouchej zmƒõny auth stavu
                    supabase.auth.onAuthStateChange((event, session) => {
                        console.log('Auth state changed:', event, session);
                        if (session) {
                            this.currentUser = session.user;
                            this.showMainApp();
                            if (this.onAuthChangeCallback) {
                                this.onAuthChangeCallback(session.user);
                            }
                        } else {
                            this.currentUser = null;
                            this.showLoginScreen();
                        }
                    });
                } catch (error) {
                    console.error('Init error:', error);
                    this.showLoginScreen();
                }
            }

            setupAuthForms() {
                try {
                    console.log('Setting up auth forms...');

                    // P≈ôep√≠n√°n√≠ mezi login a register
                    const showRegisterBtn = document.getElementById('showRegisterBtn');
                    const showLoginBtn = document.getElementById('showLoginBtn');

                    if (showRegisterBtn) {
                        showRegisterBtn.addEventListener('click', () => {
                            console.log('Show register clicked');
                            document.getElementById('loginForm').classList.add('hidden');
                            document.getElementById('registerForm').classList.remove('hidden');
                            this.hideAuthMessage();
                        });
                    }

                    if (showLoginBtn) {
                        showLoginBtn.addEventListener('click', () => {
                            console.log('Show login clicked');
                            document.getElementById('registerForm').classList.add('hidden');
                            document.getElementById('loginForm').classList.remove('hidden');
                            this.hideAuthMessage();
                        });
                    }

                    // Login form
                    document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('loginEmail').value;
                        const password = document.getElementById('loginPassword').value;
                        await this.login(email, password);
                    });

                    // Register form
                    document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const email = document.getElementById('registerEmail').value;
                        const password = document.getElementById('registerPassword').value;
                        await this.register(email, password);
                    });

                    // Logout button
                    const logoutBtn = document.getElementById('logoutBtn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', () => {
                            this.logout();
                        });
                    }

                    console.log('Auth forms setup complete');
                } catch (error) {
                    console.error('Error setting up auth forms:', error);
                }
            }

            async login(email, password) {
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email,
                        password
                    });

                    if (error) throw error;

                    this.showAuthMessage('√öspƒõ≈°nƒõ p≈ôihl√°≈°en!', 'success');

                } catch (error) {
                    console.error('Login error:', error);
                    this.showAuthMessage(error.message || 'Chyba p≈ôi p≈ôihl√°≈°en√≠', 'error');
                }
            }

            async register(email, password) {
                try {
                    const { data, error } = await supabase.auth.signUp({
                        email,
                        password
                    });

                    if (error) throw error;

                    this.showAuthMessage('√öƒçet vytvo≈ôen! Zkontrolujte email pro potvrzen√≠.', 'success');

                    // P≈ôepni na login po 2 sekund√°ch
                    setTimeout(() => {
                        document.getElementById('registerForm').classList.add('hidden');
                        document.getElementById('loginForm').classList.remove('hidden');
                    }, 2000);

                } catch (error) {
                    console.error('Register error:', error);
                    this.showAuthMessage(error.message || 'Chyba p≈ôi registraci', 'error');
                }
            }

            async logout() {
                try {
                    const { error } = await supabase.auth.signOut();
                    if (error) throw error;
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Chyba p≈ôi odhl√°≈°en√≠');
                }
            }

            showLoginScreen() {
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }

            showMainApp() {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');

                if (this.currentUser) {
                    document.getElementById('userEmail').textContent = this.currentUser.email;
                }
            }

            showAuthMessage(message, type) {
                const messageEl = document.getElementById('authMessage');
                messageEl.textContent = message;
                messageEl.className = `mt-4 p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                messageEl.classList.remove('hidden');
            }

            hideAuthMessage() {
                document.getElementById('authMessage').classList.add('hidden');
            }

            onAuthChange(callback) {
                this.onAuthChangeCallback = callback;
            }

            getUserId() {
                return this.currentUser?.id || null;
            }

            getUser() {
                return this.currentUser;
            }
        }

        // ============================================
        // SUPABASE SERVICE
        // ============================================
        class SupabaseService {
            constructor(authManager) {
                this.authManager = authManager;
            }

            // ============================================
            // CLIENTS
            // ============================================
            async getClients() {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Error fetching clients:', error);
                    throw error;
                }
            }

            async createClient(clientData) {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .insert([{
                            user_id: this.authManager.getUserId(),
                            name: clientData.name,
                            hourly_rate: clientData.hourlyRate,
                            note: clientData.note
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error creating client:', error);
                    throw error;
                }
            }

            async updateClient(id, updates) {
                try {
                    const { data, error } = await supabase
                        .from('clients')
                        .update({
                            name: updates.name,
                            hourly_rate: updates.hourlyRate,
                            note: updates.note
                        })
                        .eq('id', id)
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error updating client:', error);
                    throw error;
                }
            }

            async deleteClient(id) {
                try {
                    const { error } = await supabase
                        .from('clients')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                } catch (error) {
                    console.error('Error deleting client:', error);
                    throw error;
                }
            }

            // ============================================
            // PHASES
            // ============================================
            async getPhases() {
                try {
                    const { data, error } = await supabase
                        .from('phases')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Error fetching phases:', error);
                    throw error;
                }
            }

            async getPhasesByClient(clientId) {
                try {
                    const { data, error } = await supabase
                        .from('phases')
                        .select('*')
                        .eq('client_id', clientId)
                        .order('created_at', { ascending: false });

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Error fetching phases by client:', error);
                    throw error;
                }
            }

            async createPhase(phaseData) {
                try {
                    const { data, error } = await supabase
                        .from('phases')
                        .insert([{
                            user_id: this.authManager.getUserId(),
                            client_id: phaseData.clientId,
                            name: phaseData.name,
                            description: phaseData.description,
                            hourly_rate: phaseData.hourlyRate,
                            status: phaseData.status
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error creating phase:', error);
                    throw error;
                }
            }

            async updatePhase(id, updates) {
                try {
                    const { data, error } = await supabase
                        .from('phases')
                        .update({
                            name: updates.name,
                            description: updates.description,
                            hourly_rate: updates.hourlyRate,
                            status: updates.status
                        })
                        .eq('id', id)
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error updating phase:', error);
                    throw error;
                }
            }

            async deletePhase(id) {
                try {
                    const { error } = await supabase
                        .from('phases')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                } catch (error) {
                    console.error('Error deleting phase:', error);
                    throw error;
                }
            }

            // ============================================
            // ENTRIES
            // ============================================
            async getEntries(filters = {}) {
                try {
                    let query = supabase
                        .from('entries')
                        .select('*')
                        .order('date', { ascending: false })
                        .order('start_time', { ascending: false });

                    if (filters.clientId) {
                        query = query.eq('client_id', filters.clientId);
                    }
                    if (filters.phaseId) {
                        query = query.eq('phase_id', filters.phaseId);
                    }
                    if (filters.dateFrom) {
                        query = query.gte('date', filters.dateFrom);
                    }
                    if (filters.dateTo) {
                        query = query.lte('date', filters.dateTo);
                    }

                    const { data, error } = await query;

                    if (error) throw error;
                    return data || [];
                } catch (error) {
                    console.error('Error fetching entries:', error);
                    throw error;
                }
            }

            async createEntry(entryData) {
                try {
                    const { data, error } = await supabase
                        .from('entries')
                        .insert([{
                            user_id: this.authManager.getUserId(),
                            client_id: entryData.clientId,
                            phase_id: entryData.phaseId,
                            date: entryData.date,
                            start_time: entryData.startTime,
                            end_time: entryData.endTime,
                            duration_minutes: entryData.durationMinutes,
                            description: entryData.description,
                            hourly_rate: entryData.hourlyRate
                        }])
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error creating entry:', error);
                    throw error;
                }
            }

            async updateEntry(id, updates) {
                try {
                    const { data, error } = await supabase
                        .from('entries')
                        .update({
                            client_id: updates.clientId,
                            phase_id: updates.phaseId,
                            date: updates.date,
                            start_time: updates.startTime,
                            end_time: updates.endTime,
                            duration_minutes: updates.durationMinutes,
                            description: updates.description,
                            hourly_rate: updates.hourlyRate
                        })
                        .eq('id', id)
                        .select()
                        .single();

                    if (error) throw error;
                    return data;
                } catch (error) {
                    console.error('Error updating entry:', error);
                    throw error;
                }
            }

            async deleteEntry(id) {
                try {
                    const { error } = await supabase
                        .from('entries')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                } catch (error) {
                    console.error('Error deleting entry:', error);
                    throw error;
                }
            }

            // ============================================
            // SETTINGS
            // ============================================
            async getSettings() {
                try {
                    const { data, error } = await supabase
                        .from('settings')
                        .select('*')
                        .eq('user_id', this.authManager.getUserId())
                        .single();

                    if (error) {
                        // Pokud nastaven√≠ neexistuje, vytvo≈ô defaultn√≠
                        if (error.code === 'PGRST116') {
                            return await this.createDefaultSettings();
                        }
                        throw error;
                    }

                    return {
                        defaultHourlyRate: data.default_hourly_rate,
                        currency: data.currency
                    };
                } catch (error) {
                    console.error('Error fetching settings:', error);
                    throw error;
                }
            }

            async createDefaultSettings() {
                try {
                    const { data, error } = await supabase
                        .from('settings')
                        .insert([{
                            user_id: this.authManager.getUserId(),
                            default_hourly_rate: 850,
                            currency: 'Kƒç'
                        }])
                        .select()
                        .single();

                    if (error) throw error;

                    return {
                        defaultHourlyRate: data.default_hourly_rate,
                        currency: data.currency
                    };
                } catch (error) {
                    console.error('Error creating default settings:', error);
                    throw error;
                }
            }

            async updateSettings(settings) {
                try {
                    const { data, error } = await supabase
                        .from('settings')
                        .upsert({
                            user_id: this.authManager.getUserId(),
                            default_hourly_rate: settings.defaultHourlyRate,
                            currency: settings.currency,
                            updated_at: new Date().toISOString()
                        })
                        .select()
                        .single();

                    if (error) throw error;

                    return {
                        defaultHourlyRate: data.default_hourly_rate,
                        currency: data.currency
                    };
                } catch (error) {
                    console.error('Error updating settings:', error);
                    throw error;
                }
            }

            // ============================================
            // HELPER - Zobrazen√≠ sync indik√°toru
            // ============================================
            showSyncIndicator(message, type = 'syncing') {
                const indicator = document.getElementById('syncIndicator');
                const text = document.getElementById('syncIndicatorText');

                const icons = {
                    syncing: 'üîÑ',
                    success: '‚úÖ',
                    error: '‚ö†Ô∏è',
                    offline: 'üì°'
                };

                const colors = {
                    syncing: 'bg-blue-100 text-blue-800',
                    success: 'bg-green-100 text-green-800',
                    error: 'bg-red-100 text-red-800',
                    offline: 'bg-yellow-100 text-yellow-800'
                };

                text.textContent = `${icons[type]} ${message}`;
                indicator.className = `save-indicator ${colors[type]}`;
                indicator.classList.remove('hidden');

                if (type === 'success') {
                    setTimeout(() => {
                        indicator.classList.add('hidden');
                    }, 2000);
                }
            }
        }

        // ============================================
        // DATA MANAGER (Cache & Helpers)
        // ============================================
        class DataManager {
            constructor(supabaseService) {
                this.supabaseService = supabaseService;
                this.data = {
                    settings: {
                        defaultHourlyRate: 850,
                        currency: 'Kƒç'
                    },
                    clients: [],
                    phases: [],
                    entries: []
                };
            }

            // ============================================
            // CACHE MANAGEMENT (localStorage fallback)
            // ============================================
            saveToCache() {
                try {
                    localStorage.setItem('workTrackerCache', JSON.stringify(this.data));
                } catch (e) {
                    console.error('Error saving to cache:', e);
                }
            }

            loadFromCache() {
                try {
                    const cached = localStorage.getItem('workTrackerCache');
                    if (cached) {
                        this.data = JSON.parse(cached);
                        return true;
                    }
                } catch (e) {
                    console.error('Error loading from cache:', e);
                }
                return false;
            }

            // ============================================
            // DATA SYNC - Naƒçten√≠ ze Supabase do cache
            // ============================================
            async syncFromSupabase() {
                try {
                    this.supabaseService.showSyncIndicator('Naƒç√≠t√°m data...', 'syncing');

                    const [clients, phases, entries, settings] = await Promise.all([
                        this.supabaseService.getClients(),
                        this.supabaseService.getPhases(),
                        this.supabaseService.getEntries(),
                        this.supabaseService.getSettings()
                    ]);

                    // P≈ôevod z DB form√°tu (snake_case) na aplikaƒçn√≠ form√°t (camelCase)
                    this.data.clients = clients.map(c => ({
                        id: c.id,
                        name: c.name,
                        hourlyRate: c.hourly_rate,
                        note: c.note,
                        createdAt: c.created_at
                    }));

                    this.data.phases = phases.map(p => ({
                        id: p.id,
                        clientId: p.client_id,
                        name: p.name,
                        description: p.description,
                        hourlyRate: p.hourly_rate,
                        status: p.status,
                        createdAt: p.created_at
                    }));

                    this.data.entries = entries.map(e => ({
                        id: e.id,
                        clientId: e.client_id,
                        phaseId: e.phase_id,
                        date: e.date,
                        startTime: e.start_time,
                        endTime: e.end_time,
                        durationMinutes: e.duration_minutes,
                        description: e.description,
                        hourlyRate: e.hourly_rate,
                        createdAt: e.created_at
                    }));

                    this.data.settings = settings;

                    this.saveToCache();
                    this.supabaseService.showSyncIndicator('Synchronizov√°no', 'success');

                    return true;
                } catch (error) {
                    console.error('Error syncing from Supabase:', error);
                    this.supabaseService.showSyncIndicator('Offline re≈æim', 'offline');
                    // Pokus se naƒç√≠st z cache
                    return this.loadFromCache();
                }
            }

            // ============================================
            // HELPER METHODS
            // ============================================
            getClient(id) {
                return this.data.clients.find(c => c.id === id);
            }

            getPhasesByClient(clientId) {
                return this.data.phases.filter(p => p.clientId === clientId);
            }

            getEntriesByClient(clientId) {
                return this.data.entries.filter(e => e.clientId === clientId);
            }

            getEntriesByPhase(phaseId) {
                return this.data.entries.filter(e => e.phaseId === phaseId);
            }

            // Vypoƒç√≠t√° duration a urƒç√≠ hodinovou sazbu
            prepareEntry(entry) {
                // Calculate duration
                const start = new Date(`${entry.date} ${entry.startTime}`);
                const end = new Date(`${entry.date} ${entry.endTime}`);
                const durationMinutes = Math.round((end - start) / 60000);

                // Determine hourly rate
                let hourlyRate = entry.hourlyRate;

                if (!hourlyRate) {
                    if (entry.phaseId) {
                        const phase = this.data.phases.find(p => p.id === entry.phaseId);
                        if (phase && phase.hourlyRate) {
                            hourlyRate = phase.hourlyRate;
                        }
                    }
                    if (!hourlyRate) {
                        const client = this.getClient(entry.clientId);
                        if (client && client.hourlyRate) {
                            hourlyRate = client.hourlyRate;
                        }
                    }
                    if (!hourlyRate) {
                        hourlyRate = this.data.settings.defaultHourlyRate;
                    }
                }

                return {
                    ...entry,
                    durationMinutes,
                    hourlyRate
                };
            }

            // Statistics
            calculateStats(entries) {
                const totalMinutes = entries.reduce((sum, e) => sum + (e.durationMinutes || 0), 0);
                const totalAmount = entries.reduce((sum, e) => sum + ((e.durationMinutes || 0) / 60 * (e.hourlyRate || 0)), 0);

                return {
                    hours: Math.floor(totalMinutes / 60),
                    minutes: totalMinutes % 60,
                    totalMinutes,
                    amount: totalAmount
                };
            }
        }

        // ============================================
        // UI HELPERS
        // ============================================
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('cs-CZ').format(Math.round(amount)) + ' Kƒç';
        };

        const formatTime = (hours, minutes) => {
            if (minutes > 0) {
                return `${hours} h ${minutes} min`;
            }
            return `${hours} h`;
        };

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            return date.toLocaleDateString('cs-CZ');
        };

        const getTodayDate = () => {
            return new Date().toISOString().split('T')[0];
        };

        const getWeekStart = () => {
            const date = new Date();
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff)).toISOString().split('T')[0];
        };

        const getMonthStart = () => {
            const date = new Date();
            return new Date(date.getFullYear(), date.getMonth(), 1).toISOString().split('T')[0];
        };

        // ============================================
        // APPLICATION
        // ============================================
        class App {
            constructor() {
                // Vytvo≈ôen√≠ slu≈æeb
                this.authManager = new AuthManager();
                this.supabaseService = new SupabaseService(this.authManager);
                this.dataManager = new DataManager(this.supabaseService);

                this.currentEditingClient = null;
                this.currentEditingPhase = null;
                this.currentEditingEntry = null;
                this.currentPhaseClientId = null;
                this.charts = {
                    clients: null,
                    phases: null,
                    timeline: null
                };
                this.dashboardFilters = {
                    client: '',
                    phase: '',
                    dateFrom: '',
                    dateTo: ''
                };
            }

            async init() {
                // Inicializuj autentizaci
                await this.authManager.init();

                // Po p≈ôihl√°≈°en√≠ nastav callback pro naƒçten√≠ dat
                this.authManager.onAuthChange(async (user) => {
                    if (user) {
                        await this.loadData();
                        this.setupUI();
                    }
                });

                // Pokud je u≈æivatel p≈ôihl√°≈°en, naƒçti data
                if (this.authManager.currentUser) {
                    await this.loadData();
                    this.setupUI();
                }
            }

            async loadData() {
                await this.dataManager.syncFromSupabase();
                this.render();
            }

            setupUI() {
                this.setupNavigation();
                this.setupForms();
                this.setupModals();
                this.setupRealtime();
            }

            setupNavigation() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const section = e.target.dataset.section;
                        this.showSection(section);
                    });
                });
            }

            showSection(section) {
                // Update nav
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');

                // Update sections
                document.querySelectorAll('.section').forEach(s => {
                    s.classList.remove('active');
                });
                document.getElementById(section).classList.add('active');

                // Render section
                this.renderSection(section);
            }

            setupForms() {
                // Quick Add Form
                document.getElementById('quickAddForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const entryData = {
                        clientId: document.getElementById('quickClientId').value,
                        phaseId: document.getElementById('quickPhaseId').value || null,
                        date: document.getElementById('quickDate').value,
                        startTime: document.getElementById('quickStartTime').value,
                        endTime: document.getElementById('quickEndTime').value,
                        description: document.getElementById('quickDescription').value,
                        hourlyRate: parseInt(document.getElementById('quickRate').value) || null
                    };

                    // P≈ôiprav entry (vypoƒç√≠tej duration a hourly rate)
                    const preparedEntry = this.dataManager.prepareEntry(entryData);

                    try {
                        this.supabaseService.showSyncIndicator('Ukl√°d√°m...', 'syncing');
                        await this.supabaseService.createEntry(preparedEntry);
                        await this.dataManager.syncFromSupabase();
                        e.target.reset();
                        document.getElementById('quickDate').value = getTodayDate();
                        this.render();
                        this.supabaseService.showSyncIndicator('Ulo≈æeno', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba p≈ôi ukl√°d√°n√≠', 'error');
                        alert('Nepoda≈ôilo se ulo≈æit z√°znam');
                    }
                });

                // Settings Form
                document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        this.supabaseService.showSyncIndicator('Ukl√°d√°m...', 'syncing');
                        await this.supabaseService.updateSettings({
                            defaultHourlyRate: parseInt(document.getElementById('settingsDefaultRate').value),
                            currency: document.getElementById('settingsCurrency').value
                        });
                        await this.dataManager.syncFromSupabase();
                        this.supabaseService.showSyncIndicator('Ulo≈æeno', 'success');
                        alert('Nastaven√≠ ulo≈æeno');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se ulo≈æit nastaven√≠');
                    }
                });

                // Client Form
                document.getElementById('clientForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const client = {
                        name: document.getElementById('clientName').value,
                        hourlyRate: parseInt(document.getElementById('clientRate').value) || null,
                        note: document.getElementById('clientNote').value
                    };

                    try {
                        this.supabaseService.showSyncIndicator('Ukl√°d√°m...', 'syncing');
                        if (this.currentEditingClient) {
                            await this.supabaseService.updateClient(this.currentEditingClient, client);
                        } else {
                            await this.supabaseService.createClient(client);
                        }
                        await this.dataManager.syncFromSupabase();
                        this.closeModal('clientModal');
                        this.render();
                        this.supabaseService.showSyncIndicator('Ulo≈æeno', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se ulo≈æit klienta');
                    }
                });

                // Phase Form
                document.getElementById('phaseForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const phase = {
                        clientId: this.currentPhaseClientId,
                        name: document.getElementById('phaseName').value,
                        description: document.getElementById('phaseDescription').value,
                        hourlyRate: parseInt(document.getElementById('phaseRate').value) || null,
                        status: document.getElementById('phaseStatus').value
                    };

                    try {
                        this.supabaseService.showSyncIndicator('Ukl√°d√°m...', 'syncing');
                        if (this.currentEditingPhase) {
                            await this.supabaseService.updatePhase(this.currentEditingPhase, phase);
                        } else {
                            await this.supabaseService.createPhase(phase);
                        }
                        await this.dataManager.syncFromSupabase();
                        this.closeModal('phaseModal');
                        this.render();
                        this.supabaseService.showSyncIndicator('Ulo≈æeno', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se ulo≈æit f√°zi');
                    }
                });

                // Entry Form
                document.getElementById('entryForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const entryData = {
                        clientId: document.getElementById('entryClientId').value,
                        phaseId: document.getElementById('entryPhaseId').value || null,
                        date: document.getElementById('entryDate').value,
                        startTime: document.getElementById('entryStartTime').value,
                        endTime: document.getElementById('entryEndTime').value,
                        description: document.getElementById('entryDescription').value,
                        hourlyRate: parseInt(document.getElementById('entryRate').value) || null
                    };

                    const preparedEntry = this.dataManager.prepareEntry(entryData);

                    try {
                        this.supabaseService.showSyncIndicator('Ukl√°d√°m...', 'syncing');
                        if (this.currentEditingEntry) {
                            await this.supabaseService.updateEntry(this.currentEditingEntry, preparedEntry);
                        }
                        await this.dataManager.syncFromSupabase();
                        this.closeModal('entryModal');
                        this.render();
                        this.supabaseService.showSyncIndicator('Ulo≈æeno', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se ulo≈æit z√°znam');
                    }
                });

                // Client selection change
                document.getElementById('quickClientId').addEventListener('change', (e) => {
                    this.updatePhaseOptions('quickPhaseId', e.target.value);
                });

                document.getElementById('entryClientId').addEventListener('change', (e) => {
                    this.updatePhaseOptions('entryPhaseId', e.target.value);
                });

                // Filter changes
                document.getElementById('filterClient').addEventListener('change', () => this.renderEntriesList());
                document.getElementById('filterPhase').addEventListener('change', () => this.renderEntriesList());
                document.getElementById('filterDateFrom').addEventListener('change', () => this.renderEntriesList());
                document.getElementById('filterDateTo').addEventListener('change', () => this.renderEntriesList());

                // Report buttons
                document.getElementById('generateReportBtn').addEventListener('click', () => this.generateReport());
                document.getElementById('exportNotionBtn').addEventListener('click', () => this.exportNotion());

                // Dashboard filters
                document.getElementById('dashboardFilterClient').addEventListener('change', (e) => {
                    this.updateDashboardPhaseOptions(e.target.value);
                });

                document.getElementById('applyDashboardFilters').addEventListener('click', () => {
                    this.dashboardFilters.client = document.getElementById('dashboardFilterClient').value;
                    this.dashboardFilters.phase = document.getElementById('dashboardFilterPhase').value;
                    this.dashboardFilters.dateFrom = document.getElementById('dashboardFilterDateFrom').value;
                    this.dashboardFilters.dateTo = document.getElementById('dashboardFilterDateTo').value;
                    this.renderDashboard();
                });

                document.getElementById('resetDashboardFilters').addEventListener('click', () => {
                    this.dashboardFilters = {
                        client: '',
                        phase: '',
                        dateFrom: '',
                        dateTo: ''
                    };
                    document.getElementById('dashboardFilterClient').value = '';
                    document.getElementById('dashboardFilterPhase').value = '';
                    document.getElementById('dashboardFilterDateFrom').value = '';
                    document.getElementById('dashboardFilterDateTo').value = '';
                    this.updateDashboardPhaseOptions('');
                    this.renderDashboard();
                });

                // Toggle filtered entries list
                document.getElementById('toggleFilteredEntries').addEventListener('click', () => {
                    const list = document.getElementById('filteredEntriesList');
                    if (list.style.display === 'none') {
                        list.style.display = 'block';
                    } else {
                        list.style.display = 'none';
                    }
                });
            }

            setupModals() {
                // Client Modal
                document.getElementById('addClientBtn').addEventListener('click', () => {
                    this.currentEditingClient = null;
                    document.getElementById('clientModalTitle').textContent = 'P≈ôidat klienta';
                    document.getElementById('clientForm').reset();
                    this.openModal('clientModal');
                });

                document.getElementById('closeClientModal').addEventListener('click', () => this.closeModal('clientModal'));
                document.getElementById('cancelClientModal').addEventListener('click', () => this.closeModal('clientModal'));

                // Phase Modal
                document.getElementById('closePhaseModal').addEventListener('click', () => this.closeModal('phaseModal'));
                document.getElementById('cancelPhaseModal').addEventListener('click', () => this.closeModal('phaseModal'));

                // Entry Modal
                document.getElementById('closeEntryModal').addEventListener('click', () => this.closeModal('entryModal'));
                document.getElementById('cancelEntryModal').addEventListener('click', () => this.closeModal('entryModal'));
            }

            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }

            setupRealtime() {
                // Realtime synchronizace - poslouch√° zmƒõny z jin√Ωch za≈ô√≠zen√≠
                const userId = this.authManager.getUserId();

                supabase
                    .channel('work-tracker-changes')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'clients',
                        filter: `user_id=eq.${userId}`
                    }, async (payload) => {
                        console.log('Clients changed:', payload);
                        await this.dataManager.syncFromSupabase();
                        this.renderClientsList();
                        this.updateClientOptions();
                    })
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'phases',
                        filter: `user_id=eq.${userId}`
                    }, async (payload) => {
                        console.log('Phases changed:', payload);
                        await this.dataManager.syncFromSupabase();
                        this.renderClientsList();
                    })
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'entries',
                        filter: `user_id=eq.${userId}`
                    }, async (payload) => {
                        console.log('Entries changed:', payload);
                        await this.dataManager.syncFromSupabase();
                        this.render();
                    })
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'settings',
                        filter: `user_id=eq.${userId}`
                    }, async (payload) => {
                        console.log('Settings changed:', payload);
                        await this.dataManager.syncFromSupabase();
                        this.renderSettings();
                    })
                    .subscribe();
            }

            render() {
                this.renderDashboard();
                this.renderClientsList();
                this.renderEntriesList();
                this.updateClientOptions();
                this.updatePhaseOptions('quickPhaseId', document.getElementById('quickClientId').value);
                this.renderSettings();
            }

            renderSection(section) {
                switch (section) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'clients':
                        this.renderClientsList();
                        break;
                    case 'entries':
                        this.renderEntriesList();
                        break;
                    case 'reports':
                        this.generateReport();
                        break;
                    case 'settings':
                        this.renderSettings();
                        break;
                }
            }

            renderDashboard() {
                // Apply filters helper
                const applyFilters = (entries) => {
                    let filtered = [...entries];

                    if (this.dashboardFilters.client) {
                        filtered = filtered.filter(e => e.clientId === this.dashboardFilters.client);
                    }
                    if (this.dashboardFilters.phase) {
                        filtered = filtered.filter(e => e.phaseId === this.dashboardFilters.phase);
                    }
                    if (this.dashboardFilters.dateFrom) {
                        filtered = filtered.filter(e => e.date >= this.dashboardFilters.dateFrom);
                    }
                    if (this.dashboardFilters.dateTo) {
                        filtered = filtered.filter(e => e.date <= this.dashboardFilters.dateTo);
                    }

                    return filtered;
                };

                // Stats
                const today = getTodayDate();
                const weekStart = getWeekStart();
                const monthStart = getMonthStart();

                let todayEntries = this.dataManager.data.entries.filter(e => e.date === today);
                let weekEntries = this.dataManager.data.entries.filter(e => e.date >= weekStart);
                let monthEntries = this.dataManager.data.entries.filter(e => e.date >= monthStart);

                // Apply filters
                todayEntries = applyFilters(todayEntries);
                weekEntries = applyFilters(weekEntries);
                monthEntries = applyFilters(monthEntries);

                const todayStats = this.dataManager.calculateStats(todayEntries);
                const weekStats = this.dataManager.calculateStats(weekEntries);
                const monthStats = this.dataManager.calculateStats(monthEntries);

                document.getElementById('statsToday').textContent = formatTime(todayStats.hours, todayStats.minutes);
                document.getElementById('statsTodayAmount').textContent = formatCurrency(todayStats.amount);

                document.getElementById('statsWeek').textContent = formatTime(weekStats.hours, weekStats.minutes);
                document.getElementById('statsWeekAmount').textContent = formatCurrency(weekStats.amount);

                document.getElementById('statsMonth').textContent = formatTime(monthStats.hours, monthStats.minutes);
                document.getElementById('statsMonthAmount').textContent = formatCurrency(monthStats.amount);

                // Recent Entries
                let allEntries = applyFilters(this.dataManager.data.entries);
                const recentEntries = [...allEntries]
                    .sort((a, b) => new Date(b.date + ' ' + b.startTime) - new Date(a.date + ' ' + a.startTime))
                    .slice(0, 5);

                const recentEntriesEl = document.getElementById('recentEntries');
                if (recentEntries.length === 0) {
                    recentEntriesEl.innerHTML = '<p class="text-gray-500 text-sm">≈Ω√°dn√© z√°znamy</p>';
                } else {
                    recentEntriesEl.innerHTML = recentEntries.map(entry => {
                        const client = this.dataManager.getClient(entry.clientId);
                        const amount = (entry.durationMinutes / 60) * entry.hourlyRate;
                        return `
                            <div class="border-b pb-2">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-medium">${client ? client.name : 'Nezn√°m√Ω klient'}</p>
                                        <p class="text-sm text-gray-600">${entry.description}</p>
                                        <p class="text-xs text-gray-500">${formatDate(entry.date)} ‚Ä¢ ${entry.startTime} - ${entry.endTime}</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium">${formatTime(Math.floor(entry.durationMinutes / 60), entry.durationMinutes % 60)}</p>
                                        <p class="text-sm text-gray-600">${formatCurrency(amount)}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Set today's date in quick add
                document.getElementById('quickDate').value = getTodayDate();

                // Render filtered entries list
                this.renderFilteredEntriesList(allEntries);

                // Render charts
                this.renderCharts();
            }

            renderFilteredEntriesList(entries) {
                const filteredEntriesListEl = document.getElementById('filteredEntriesList');

                // Calculate totals
                const stats = this.dataManager.calculateStats(entries);

                // Update totals
                document.getElementById('filteredTotalHours').textContent = formatTime(stats.hours, stats.minutes);
                document.getElementById('filteredTotalAmount').textContent = formatCurrency(stats.amount);
                document.getElementById('filteredTotalCount').textContent = entries.length;

                // Sort entries by date and time (newest first)
                const sortedEntries = [...entries].sort((a, b) =>
                    new Date(b.date + ' ' + b.startTime) - new Date(a.date + ' ' + a.startTime)
                );

                if (sortedEntries.length === 0) {
                    filteredEntriesListEl.innerHTML = '<p class="text-gray-500 text-sm">≈Ω√°dn√© ƒçinnosti pro vybran√© filtry</p>';
                    return;
                }

                filteredEntriesListEl.innerHTML = sortedEntries.map(entry => {
                    const client = this.dataManager.getClient(entry.clientId);
                    const phase = entry.phaseId ? this.dataManager.data.phases.find(p => p.id === entry.phaseId) : null;
                    const amount = (entry.durationMinutes / 60) * entry.hourlyRate;
                    const hours = Math.floor(entry.durationMinutes / 60);
                    const minutes = entry.durationMinutes % 60;

                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="font-semibold text-gray-900">${client ? client.name : 'Nezn√°m√Ω klient'}</span>
                                        ${phase ? `<span class="text-xs px-2 py-1 bg-blue-100 text-blue-800 rounded">${phase.name}</span>` : ''}
                                    </div>
                                    <p class="text-sm text-gray-700 mb-2">${entry.description}</p>
                                    <div class="flex gap-4 text-xs text-gray-500">
                                        <span>üìÖ ${formatDate(entry.date)}</span>
                                        <span>üïí ${entry.startTime} - ${entry.endTime}</span>
                                        <span>üí∞ ${entry.hourlyRate} Kƒç/h</span>
                                    </div>
                                </div>
                                <div class="text-right ml-4">
                                    <p class="text-lg font-bold text-gray-900">${formatTime(hours, minutes)}</p>
                                    <p class="text-sm font-semibold text-blue-600">${formatCurrency(amount)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderCharts() {
                const monthStart = getMonthStart();
                const monthEntries = this.dataManager.data.entries.filter(e => e.date >= monthStart);

                // Destroy existing charts
                if (this.charts.clients) this.charts.clients.destroy();
                if (this.charts.phases) this.charts.phases.destroy();
                if (this.charts.timeline) this.charts.timeline.destroy();

                // Clients Chart
                this.renderClientsChart(monthEntries);

                // Phases Chart
                this.renderPhasesChart(monthEntries);

                // Timeline Chart
                this.renderTimelineChart(monthEntries);
            }

            renderClientsChart(entries) {
                const clientData = {};

                entries.forEach(entry => {
                    const client = this.dataManager.getClient(entry.clientId);
                    const clientName = client ? client.name : 'Nezn√°m√Ω';

                    if (!clientData[clientName]) {
                        clientData[clientName] = 0;
                    }
                    clientData[clientName] += entry.durationMinutes / 60;
                });

                const labels = Object.keys(clientData);
                const data = Object.values(clientData);
                const colors = [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6',
                    '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'
                ];

                const ctx = document.getElementById('clientsChart');
                this.charts.clients = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const hours = context.parsed;
                                        const minutes = Math.round((hours % 1) * 60);
                                        return context.label + ': ' + Math.floor(hours) + ' h ' + (minutes > 0 ? minutes + ' min' : '');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderPhasesChart(entries) {
                const phaseData = {};

                entries.forEach(entry => {
                    let phaseName = 'Bez f√°ze';

                    if (entry.phaseId) {
                        const phase = this.dataManager.data.phases.find(p => p.id === entry.phaseId);
                        if (phase) {
                            phaseName = phase.name;
                        }
                    }

                    if (!phaseData[phaseName]) {
                        phaseData[phaseName] = 0;
                    }
                    phaseData[phaseName] += entry.durationMinutes / 60;
                });

                const labels = Object.keys(phaseData);
                const data = Object.values(phaseData);
                const colors = [
                    '#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6',
                    '#EC4899', '#14B8A6', '#F97316', '#6366F1', '#84CC16'
                ];

                const ctx = document.getElementById('phasesChart');
                this.charts.phases = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const hours = context.parsed;
                                        const minutes = Math.round((hours % 1) * 60);
                                        return context.label + ': ' + Math.floor(hours) + ' h ' + (minutes > 0 ? minutes + ' min' : '');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderTimelineChart(entries) {
                // Group entries by date
                const dateData = {};

                entries.forEach(entry => {
                    if (!dateData[entry.date]) {
                        dateData[entry.date] = 0;
                    }
                    dateData[entry.date] += entry.durationMinutes / 60;
                });

                // Sort dates
                const sortedDates = Object.keys(dateData).sort();
                const data = sortedDates.map(date => dateData[date]);
                const labels = sortedDates.map(date => {
                    const d = new Date(date);
                    return d.getDate() + '.' + (d.getMonth() + 1) + '.';
                });

                const ctx = document.getElementById('timelineChart');
                this.charts.timeline = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Hodiny',
                            data: data,
                            backgroundColor: '#3B82F6',
                            borderColor: '#2563EB',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' h';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const hours = context.parsed.y;
                                        const minutes = Math.round((hours % 1) * 60);
                                        return Math.floor(hours) + ' h ' + (minutes > 0 ? minutes + ' min' : '');
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderClientsList() {
                const clients = this.dataManager.data.clients;
                const clientsListEl = document.getElementById('clientsList');

                if (clients.length === 0) {
                    clientsListEl.innerHTML = '<p class="text-gray-500">≈Ω√°dn√≠ klienti</p>';
                    return;
                }

                clientsListEl.innerHTML = clients.map(client => {
                    const entries = this.dataManager.getEntriesByClient(client.id);
                    const stats = this.dataManager.calculateStats(entries);
                    const phases = this.dataManager.getPhasesByClient(client.id);

                    return `
                        <div class="card">
                            <div class="flex justify-between items-start mb-4">
                                <div>
                                    <h3 class="text-xl font-bold">${client.name}</h3>
                                    ${client.note ? `<p class="text-sm text-gray-600 mt-1">${client.note}</p>` : ''}
                                    <p class="text-sm text-gray-500 mt-1">Sazba: ${client.hourlyRate ? formatCurrency(client.hourlyRate) + '/h' : 'V√Ωchoz√≠'}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="app.editClient('${client.id}')" class="btn-secondary text-sm">‚úèÔ∏è Upravit</button>
                                    <button onclick="app.deleteClient('${client.id}')" class="btn-danger text-sm">üóëÔ∏è</button>
                                </div>
                            </div>

                            <div class="grid grid-cols-3 gap-4 mb-4 p-4 bg-gray-50 rounded">
                                <div>
                                    <p class="text-sm text-gray-500">Celkem hodin</p>
                                    <p class="text-lg font-bold">${formatTime(stats.hours, stats.minutes)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Celkov√° ƒç√°stka</p>
                                    <p class="text-lg font-bold">${formatCurrency(stats.amount)}</p>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Poƒçet z√°znam≈Ø</p>
                                    <p class="text-lg font-bold">${entries.length}</p>
                                </div>
                            </div>

                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-semibold">F√°ze projektu (${phases.length})</h4>
                                    <button onclick="app.addPhase('${client.id}')" class="text-sm text-blue-600 hover:text-blue-700">+ P≈ôidat f√°zi</button>
                                </div>
                                ${phases.length > 0 ? `
                                    <div class="space-y-2">
                                        ${phases.map(phase => {
                                            const phaseEntries = this.dataManager.getEntriesByPhase(phase.id);
                                            const phaseStats = this.dataManager.calculateStats(phaseEntries);
                                            const statusClass = phase.status === 'active' ? 'status-active' : phase.status === 'completed' ? 'status-completed' : 'status-paused';
                                            const statusText = phase.status === 'active' ? '‚úÖ Aktivn√≠' : phase.status === 'completed' ? '‚òëÔ∏è Dokonƒçen√°' : '‚è∏Ô∏è Pozastaven√°';

                                            return `
                                                <div class="border rounded p-3 bg-white">
                                                    <div class="flex justify-between items-start">
                                                        <div class="flex-1">
                                                            <div class="flex items-center gap-2">
                                                                <span class="font-medium">${phase.name}</span>
                                                                <span class="status-badge ${statusClass}">${statusText}</span>
                                                            </div>
                                                            ${phase.description ? `<p class="text-sm text-gray-600 mt-1">${phase.description}</p>` : ''}
                                                            <div class="flex gap-4 mt-2 text-sm text-gray-600">
                                                                <span>${formatTime(phaseStats.hours, phaseStats.minutes)}</span>
                                                                <span>${formatCurrency(phaseStats.amount)}</span>
                                                            </div>
                                                        </div>
                                                        <div class="flex gap-1">
                                                            <button onclick="app.editPhase('${phase.id}')" class="text-blue-600 hover:text-blue-700 px-2">‚úèÔ∏è</button>
                                                            <button onclick="app.deletePhase('${phase.id}')" class="text-red-600 hover:text-red-700 px-2">üóëÔ∏è</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<p class="text-sm text-gray-500">≈Ω√°dn√© f√°ze</p>'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderEntriesList() {
                const clientFilter = document.getElementById('filterClient').value;
                const phaseFilter = document.getElementById('filterPhase').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;

                let entries = [...this.dataManager.data.entries];

                if (clientFilter) {
                    entries = entries.filter(e => e.clientId === clientFilter);
                }
                if (phaseFilter) {
                    entries = entries.filter(e => e.phaseId === phaseFilter);
                }
                if (dateFrom) {
                    entries = entries.filter(e => e.date >= dateFrom);
                }
                if (dateTo) {
                    entries = entries.filter(e => e.date <= dateTo);
                }

                entries.sort((a, b) => new Date(b.date + ' ' + b.startTime) - new Date(a.date + ' ' + a.startTime));

                const entriesListEl = document.getElementById('entriesList');

                if (entries.length === 0) {
                    entriesListEl.innerHTML = '<p class="text-gray-500">≈Ω√°dn√© z√°znamy</p>';
                    return;
                }

                entriesListEl.innerHTML = entries.map(entry => {
                    const client = this.dataManager.getClient(entry.clientId);
                    const phase = entry.phaseId ? this.dataManager.data.phases.find(p => p.id === entry.phaseId) : null;
                    const amount = (entry.durationMinutes / 60) * entry.hourlyRate;

                    return `
                        <div class="card">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <h3 class="text-lg font-bold">${client ? client.name : 'Nezn√°m√Ω klient'}</h3>
                                        ${phase ? `<span class="text-sm text-gray-600">‚Üí ${phase.name}</span>` : ''}
                                    </div>
                                    <p class="text-gray-700 mb-2">${entry.description}</p>
                                    <div class="flex gap-4 text-sm text-gray-600">
                                        <span>üìÖ ${formatDate(entry.date)}</span>
                                        <span>üïí ${entry.startTime} - ${entry.endTime}</span>
                                        <span>‚è±Ô∏è ${formatTime(Math.floor(entry.durationMinutes / 60), entry.durationMinutes % 60)}</span>
                                        <span>üí∞ ${entry.hourlyRate} Kƒç/h</span>
                                    </div>
                                </div>
                                <div class="flex items-start gap-4">
                                    <div class="text-right">
                                        <p class="text-2xl font-bold">${formatCurrency(amount)}</p>
                                    </div>
                                    <div class="flex gap-1">
                                        <button onclick="app.editEntry('${entry.id}')" class="btn-secondary text-sm">‚úèÔ∏è</button>
                                        <button onclick="app.deleteEntry('${entry.id}')" class="btn-danger text-sm">üóëÔ∏è</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            renderSettings() {
                document.getElementById('settingsDefaultRate').value = this.dataManager.data.settings.defaultHourlyRate;
                document.getElementById('settingsCurrency').value = this.dataManager.data.settings.currency;
            }

            updateClientOptions() {
                const clients = this.dataManager.data.clients;
                const selects = ['quickClientId', 'entryClientId', 'filterClient', 'reportClient', 'dashboardFilterClient'];

                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    const currentValue = select.value;
                    const isFilter = selectId.startsWith('filter') || selectId.startsWith('report');

                    select.innerHTML = isFilter
                        ? '<option value="">V≈°ichni klienti</option>'
                        : '<option value="">Vyberte klienta</option>';

                    clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id;
                        option.textContent = client.name;
                        select.appendChild(option);
                    });

                    if (currentValue) {
                        select.value = currentValue;
                    }
                });
            }

            updatePhaseOptions(selectId, clientId) {
                const select = document.getElementById(selectId);
                const currentValue = select.value;

                select.innerHTML = '<option value="">Bez f√°ze</option>';

                if (clientId) {
                    const phases = this.dataManager.getPhasesByClient(clientId);
                    phases.forEach(phase => {
                        const option = document.createElement('option');
                        option.value = phase.id;
                        option.textContent = phase.name;
                        select.appendChild(option);
                    });
                }

                if (currentValue) {
                    select.value = currentValue;
                }
            }

            updateDashboardPhaseOptions(clientId) {
                const select = document.getElementById('dashboardFilterPhase');
                const currentValue = select.value;

                select.innerHTML = '<option value="">V≈°echny f√°ze</option>';

                if (clientId) {
                    const phases = this.dataManager.getPhasesByClient(clientId);
                    phases.forEach(phase => {
                        const option = document.createElement('option');
                        option.value = phase.id;
                        option.textContent = phase.name;
                        select.appendChild(option);
                    });
                }

                if (currentValue) {
                    select.value = currentValue;
                }
            }

            // Client Actions
            editClient(id) {
                const client = this.dataManager.getClient(id);
                if (!client) return;

                this.currentEditingClient = id;
                document.getElementById('clientModalTitle').textContent = 'Upravit klienta';
                document.getElementById('clientName').value = client.name;
                document.getElementById('clientRate').value = client.hourlyRate || '';
                document.getElementById('clientNote').value = client.note || '';
                this.openModal('clientModal');
            }

            async deleteClient(id) {
                const client = this.dataManager.getClient(id);
                if (confirm(`Opravdu smazat klienta "${client.name}"? Budou smaz√°ny i v≈°echny souvisej√≠c√≠ f√°ze a z√°znamy.`)) {
                    try {
                        this.supabaseService.showSyncIndicator('Maz√°n√≠...', 'syncing');
                        await this.supabaseService.deleteClient(id);
                        await this.dataManager.syncFromSupabase();
                        this.render();
                        this.supabaseService.showSyncIndicator('Smaz√°no', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se smazat klienta');
                    }
                }
            }

            // Phase Actions
            addPhase(clientId) {
                this.currentPhaseClientId = clientId;
                this.currentEditingPhase = null;
                document.getElementById('phaseModalTitle').textContent = 'P≈ôidat f√°zi';
                document.getElementById('phaseForm').reset();
                document.getElementById('phaseStatus').value = 'active';
                this.openModal('phaseModal');
            }

            editPhase(id) {
                const phase = this.dataManager.data.phases.find(p => p.id === id);
                if (!phase) return;

                this.currentEditingPhase = id;
                this.currentPhaseClientId = phase.clientId;
                document.getElementById('phaseModalTitle').textContent = 'Upravit f√°zi';
                document.getElementById('phaseName').value = phase.name;
                document.getElementById('phaseDescription').value = phase.description || '';
                document.getElementById('phaseRate').value = phase.hourlyRate || '';
                document.getElementById('phaseStatus').value = phase.status;
                this.openModal('phaseModal');
            }

            async deletePhase(id) {
                const phase = this.dataManager.data.phases.find(p => p.id === id);
                if (confirm(`Opravdu smazat f√°zi "${phase.name}"? Budou smaz√°ny i v≈°echny souvisej√≠c√≠ z√°znamy.`)) {
                    try {
                        this.supabaseService.showSyncIndicator('Maz√°n√≠...', 'syncing');
                        await this.supabaseService.deletePhase(id);
                        await this.dataManager.syncFromSupabase();
                        this.render();
                        this.supabaseService.showSyncIndicator('Smaz√°no', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se smazat f√°zi');
                    }
                }
            }

            // Entry Actions
            editEntry(id) {
                const entry = this.dataManager.data.entries.find(e => e.id === id);
                if (!entry) return;

                this.currentEditingEntry = id;
                document.getElementById('entryModalTitle').textContent = 'Upravit z√°znam';
                document.getElementById('entryClientId').value = entry.clientId;
                this.updatePhaseOptions('entryPhaseId', entry.clientId);
                document.getElementById('entryPhaseId').value = entry.phaseId || '';
                document.getElementById('entryDate').value = entry.date;
                document.getElementById('entryStartTime').value = entry.startTime;
                document.getElementById('entryEndTime').value = entry.endTime;
                document.getElementById('entryDescription').value = entry.description;
                document.getElementById('entryRate').value = entry.hourlyRate || '';
                this.openModal('entryModal');
            }

            async deleteEntry(id) {
                if (confirm('Opravdu smazat tento z√°znam?')) {
                    try {
                        this.supabaseService.showSyncIndicator('Maz√°n√≠...', 'syncing');
                        await this.supabaseService.deleteEntry(id);
                        await this.dataManager.syncFromSupabase();
                        this.render();
                        this.supabaseService.showSyncIndicator('Smaz√°no', 'success');
                    } catch (error) {
                        this.supabaseService.showSyncIndicator('Chyba', 'error');
                        alert('Nepoda≈ôilo se smazat z√°znam');
                    }
                }
            }

            // Reports
            generateReport() {
                const clientFilter = document.getElementById('reportClient').value;
                const dateFrom = document.getElementById('reportDateFrom').value;
                const dateTo = document.getElementById('reportDateTo').value;

                let entries = [...this.dataManager.data.entries];

                if (clientFilter) {
                    entries = entries.filter(e => e.clientId === clientFilter);
                }
                if (dateFrom) {
                    entries = entries.filter(e => e.date >= dateFrom);
                }
                if (dateTo) {
                    entries = entries.filter(e => e.date <= dateTo);
                }

                const stats = this.dataManager.calculateStats(entries);

                document.getElementById('reportTotalHours').textContent = formatTime(stats.hours, stats.minutes);
                document.getElementById('reportTotalAmount').textContent = formatCurrency(stats.amount);
                document.getElementById('reportTotalEntries').textContent = entries.length;

                // Details
                const detailsEl = document.getElementById('reportDetails');
                if (entries.length === 0) {
                    detailsEl.innerHTML = '<p class="text-gray-500">≈Ω√°dn√© z√°znamy pro vybran√° krit√©ria</p>';
                    return;
                }

                entries.sort((a, b) => new Date(a.date + ' ' + a.startTime) - new Date(b.date + ' ' + b.startTime));

                detailsEl.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left">Datum</th>
                                    <th class="px-4 py-2 text-left">Klient</th>
                                    <th class="px-4 py-2 text-left">F√°ze</th>
                                    <th class="px-4 py-2 text-left">ƒåinnost</th>
                                    <th class="px-4 py-2 text-right">ƒåas</th>
                                    <th class="px-4 py-2 text-right">ƒå√°stka</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y">
                                ${entries.map(entry => {
                                    const client = this.dataManager.getClient(entry.clientId);
                                    const phase = entry.phaseId ? this.dataManager.data.phases.find(p => p.id === entry.phaseId) : null;
                                    const amount = (entry.durationMinutes / 60) * entry.hourlyRate;

                                    return `
                                        <tr>
                                            <td class="px-4 py-2">${formatDate(entry.date)}</td>
                                            <td class="px-4 py-2">${client ? client.name : '-'}</td>
                                            <td class="px-4 py-2">${phase ? phase.name : '-'}</td>
                                            <td class="px-4 py-2">${entry.description}</td>
                                            <td class="px-4 py-2 text-right">${formatTime(Math.floor(entry.durationMinutes / 60), entry.durationMinutes % 60)}</td>
                                            <td class="px-4 py-2 text-right font-medium">${formatCurrency(amount)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            exportNotion() {
                const clientFilter = document.getElementById('reportClient').value;
                const dateFrom = document.getElementById('reportDateFrom').value;
                const dateTo = document.getElementById('reportDateTo').value;

                let entries = [...this.dataManager.data.entries];

                if (clientFilter) {
                    entries = entries.filter(e => e.clientId === clientFilter);
                }
                if (dateFrom) {
                    entries = entries.filter(e => e.date >= dateFrom);
                }
                if (dateTo) {
                    entries = entries.filter(e => e.date <= dateTo);
                }

                if (entries.length === 0) {
                    alert('≈Ω√°dn√© z√°znamy pro export');
                    return;
                }

                const stats = this.dataManager.calculateStats(entries);
                const client = clientFilter ? this.dataManager.getClient(clientFilter) : null;

                entries.sort((a, b) => new Date(a.date + ' ' + a.startTime) - new Date(b.date + ' ' + b.startTime));

                let markdown = `## Report pr√°ce${client ? ': ' + client.name : ''}\n`;
                markdown += `**Obdob√≠:** ${dateFrom ? formatDate(dateFrom) : 'zaƒç√°tek'} ‚Äì ${dateTo ? formatDate(dateTo) : 'nyn√≠'}\n`;
                markdown += `**Celkem:** ${formatTime(stats.hours, stats.minutes)}\n`;
                markdown += `**K fakturaci:** ${formatCurrency(stats.amount)}\n\n`;
                markdown += `| Datum | ƒåinnost | ƒåas | ƒå√°stka |\n`;
                markdown += `|-------|---------|-----|--------|\n`;

                entries.forEach(entry => {
                    const amount = (entry.durationMinutes / 60) * entry.hourlyRate;
                    const time = formatTime(Math.floor(entry.durationMinutes / 60), entry.durationMinutes % 60);
                    markdown += `| ${formatDate(entry.date)} | ${entry.description} | ${time} | ${formatCurrency(amount)} |\n`;
                });

                markdown += `\n**Celkem: ${formatCurrency(stats.amount)}**\n`;

                // Copy to clipboard
                navigator.clipboard.writeText(markdown).then(() => {
                    alert('Report zkop√≠rov√°n do schr√°nky! M≈Ø≈æete ho vlo≈æit do Notionu.');
                }).catch(() => {
                    alert('Chyba p≈ôi kop√≠rov√°n√≠ do schr√°nky');
                });
            }

            // Migrace dat z localStorage do Supabase
            async migrateLocalData() {
                if (!confirm('Opravdu chcete importovat lok√°ln√≠ data do cloudu? Tato operace m≈Ø≈æe trvat chv√≠li.')) {
                    return;
                }

                try {
                    this.supabaseService.showSyncIndicator('Migrace dat...', 'syncing');

                    // Naƒçti star√° data z localStorage
                    const oldData = localStorage.getItem('workTrackerData');
                    if (!oldData) {
                        alert('≈Ω√°dn√° lok√°ln√≠ data k migraci');
                        return;
                    }

                    const data = JSON.parse(oldData);
                    let imported = { clients: 0, phases: 0, entries: 0 };

                    // Mapa star√Ωch ID na nov√© ID (pro zachov√°n√≠ vztah≈Ø)
                    const clientIdMap = new Map();
                    const phaseIdMap = new Map();

                    // 1. Import klient≈Ø
                    if (data.clients && data.clients.length > 0) {
                        for (const client of data.clients) {
                            const newClient = await this.supabaseService.createClient({
                                name: client.name,
                                hourlyRate: client.hourlyRate,
                                note: client.note
                            });
                            clientIdMap.set(client.id, newClient.id);
                            imported.clients++;
                        }
                    }

                    // 2. Import f√°z√≠
                    if (data.phases && data.phases.length > 0) {
                        for (const phase of data.phases) {
                            const newClientId = clientIdMap.get(phase.clientId);
                            if (newClientId) {
                                const newPhase = await this.supabaseService.createPhase({
                                    clientId: newClientId,
                                    name: phase.name,
                                    description: phase.description,
                                    hourlyRate: phase.hourlyRate,
                                    status: phase.status
                                });
                                phaseIdMap.set(phase.id, newPhase.id);
                                imported.phases++;
                            }
                        }
                    }

                    // 3. Import z√°znam≈Ø
                    if (data.entries && data.entries.length > 0) {
                        for (const entry of data.entries) {
                            const newClientId = clientIdMap.get(entry.clientId);
                            if (newClientId) {
                                await this.supabaseService.createEntry({
                                    clientId: newClientId,
                                    phaseId: entry.phaseId ? phaseIdMap.get(entry.phaseId) : null,
                                    date: entry.date,
                                    startTime: entry.startTime,
                                    endTime: entry.endTime,
                                    durationMinutes: entry.durationMinutes,
                                    description: entry.description,
                                    hourlyRate: entry.hourlyRate
                                });
                                imported.entries++;
                            }
                        }
                    }

                    // Synchronizuj data
                    await this.dataManager.syncFromSupabase();
                    this.render();

                    this.supabaseService.showSyncIndicator('Migrace dokonƒçena', 'success');
                    alert(`Migrace dokonƒçena!\n\nImportov√°no:\n- ${imported.clients} klient≈Ø\n- ${imported.phases} f√°z√≠\n- ${imported.entries} z√°znam≈Ø`);

                } catch (error) {
                    console.error('Migration error:', error);
                    this.supabaseService.showSyncIndicator('Chyba p≈ôi migraci', 'error');
                    alert('Chyba p≈ôi migraci dat: ' + error.message);
                }
            }
        }

        // ============================================
        // INITIALIZE APP
        // ============================================
        let app;

        // Inicializace po naƒçten√≠ DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

        async function initApp() {
            app = new App();
            await app.init();
        }
    </script>
</body>
</html>
